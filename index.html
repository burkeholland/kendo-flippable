<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Flip Test</title>
  <link rel="stylesheet" href="app/components/kendo-ui-core/styles/kendo.common-bootstrap.min.css">
  <link rel="stylesheet" href="app/components/kendo-ui-core/styles/kendo.silver.min.css">
  <link rel="stylesheet" href="app/components/kendo-ui-core/styles/kendo.silver.mobile.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.css">
</head>
<style>
  body, html{
    margin-top: 40px;
    background-color: #f9f9f9;
  }
  .album {
    display: none;
    height: 250px;
    margin-bottom: 60px;
  }
  .front {
    cursor: pointer;
    padding: 20px;
    border: 1px #eee solid;
    box-shadow: 0 12px 15px 0 rgba(0, 0, 0, 0.24);
  }
  .back {
    border: 1px #eee solid;
    box-shadow: 0 12px 15px 0 rgba(0, 0, 0, 0.24);
  }
  .fa {
    cursor: pointer;
  }
  .footer {
    margin-left
    margin-top: 200px;
  }
  .title {
    margin-left: 150;
  }
  .tracks {
    height: 200px;
    overflow: scroll;
    -webkit-overflow-scrolling: touch;
  }
  .album-cover {
    text-align: center;
    margin-bottom: 20px;
  }
  .album-cover > img {
    height: 100px;
    margin-bottom: 10px;
  }
  .album-img {
    position: absolute;
  }
  .progress {
    width: 90%;
    margin-left: 20px;
  }
  .subtext {
    font-size: 12px;
  }
</style>

<body>
  
  <audio id="player" style="display: none"></audio>

  <div class="container">
    <div class="row">
      <div class="col-xs-12">
        <h1>Anberlin</h1>
      </div>
    </div>
  </div>

  <br>

  <div class="container" data-bind="source: albumsDs" data-template="itunes-template"></div>

  <script type="text/x-kendo-template" id="itunes-template">
    <div class="col-sm-4">
      <div class="album" data-role="flippable" data-bind="events: { flipStart: flipStart }">
        <div class="back">
          <div data-role="kendo.mobile.ui.NavBar">
            <span data-role="kendo.mobile.ui.ViewTitle">Tracks</span>
            <div data-role="kendo.mobile.ui.Button" data-bind="click: flip" data-align="left">Back</div>
          </div> 
          <div class="tracks">
            <ul data-role="kendo.mobile.ui.ListView" data-bind="source: tracks" data-auto-bind="false" data-template="track-template"></table>
          </div>
        </div>
        <div class="front" data-role="touch" data-bind="events: { tap: flip }">
          <div class="row">
            <div class="col-lg-5">
              <div class="album-cover">
                <img class="img-circle" src="#: artworkUrl100 #">
                <p><span class="badge">#: trackCount #</span> tracks</p>
              </div>
            </div>
            <div class="col-lg-7">
              <div class="row">
                <div class="col-xs-12">
                  <h4> #: collectionCensoredName #</h4>
                </div>
                <div class="col-xs-12 hidden-md hidden-sm">
                  <p>Released #: kendo.toString(releaseDate, "MMM d, yyyy") #</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/x-kendo-template" id="track-template">

        <i class="fa fa-play" data-bind="click: play, invisible: isPlaying"></i>
        <i class="fa fa-pause" data-bind="click: stop, visible: isPlaying"></i>
    
        <span> #: trackName #</span>        
    
  </script>

  <br>

  <script src="app/components/kendo-ui-core/js/jquery.min.js"></script>
  <script src="app/components/kendo-ui-core/js/kendo.ui.core.min.js"></script >
  <script src="kendo.flippable.js"></script>


  <script>


    (function ($) {

      var artistID = 16269045,
          player = $('#player')[0];

      var model = kendo.observable({
        albumId: 0,
        albumsDs:  new kendo.data.DataSource({
          transport: {
            read: {
              url: "https://itunes.apple.com/lookup?id=" + artistID + "&entity=album",
              dataType: "jsonp"
            },
          },
          schema: {
            data: "results",
            parse: function(data) {
              $.each(data.results, function() {
                this.tracks = new kendo.data.ObservableArray([]);
              });
              return data;
            },
            model: {
              id: "collectionId",
              fields: {
                releaseDate: {
                  type: "date"
                }
              }
            }
          },
          filter: { field: "wrapperType", operator: "equals", value: "collection" }
        }),
        tracksDs: new kendo.data.DataSource({
          transport: {
            read: {
              url: function() {
                return "https://itunes.apple.com/lookup?id=" + model.get("albumId") + "&entity=song";
              },
              dataType: "jsonp"
            },
          },
          change: function(e) {
            
            var albums = model.get('albumsDs'),
                id = model.get('albumId'),
                album = albums.get(id);

            album.set("tracks", this.view());

          },
          schema: {
            data: "results",
            parse: function(data) {
              $.each(data.results, function() {
                this.isPlaying = false;
              });
              return data;
            },
            model: {
              id: 'collectionId',
              fields: {
                releaseDate: {
                  type: "date"
                }
              }
            }
          },
          filter: { field: "wrapperType", operator: "equals", value: "track" }
        }),
        flip: function(e) {
          
          player.pause();

          resetPlayButtons();

          var flippable = $(e.sender.element).closest("[data-role='flippable']").data('kendoFlippable');
          flippable.flipHorizontal();
        },
        flipStart: function(e) {
          
          this.set('albumId', e.data.collectionId);

          if (e.data.tracks.length > 0) {
            return;
          }
          else {
            var tracks = this.get('tracksDs');
            tracks.read();
          }
        },
        play: function(e) {

          resetPlayButtons();

          player.src = e.data.previewUrl;
          player.play();
          
          e.data.set('isPlaying', true);
        },
        stop: function(e) {
          player.pause();
          player.currentTime = 0;
          e.data.set('isPlaying', false);
        }
      });

      var resetPlayButtons = function() {
        $('.fa-pause').hide();
        $('.fa-play').show();
      }

      kendo.bind(document.body, model);

    }(jQuery));

  </script>

</body>
</html>